<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pagar con PayPhone — MACVASQUEZ</title>
<style>
  body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:0; background:#fff; color:#111; }
  .wrap { max-width: 640px; margin: 24px auto; padding: 16px; }
  .card { background:#fff; border:1px solid rgba(17,24,39,.08); border-radius:18px; box-shadow:0 12px 40px rgba(0,0,0,.06); padding:20px; }
  h1 { font-size: 1.25rem; margin: 0 0 12px; }
  .muted { color:#6B7280; font-size:.95rem; }
  .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
  .pill { background:#F3F4F6; border-radius:999px; padding:6px 12px; font-size:.9rem; }
  .payment-button { display:inline-flex; align-items:center; gap:8px; padding:12px 18px; border-radius:12px; border:1px solid rgba(17,24,39,.1); text-decoration:none; }
  .payment-button:hover { background:#F9FAFB; }
  .center { text-align:center; }
  .spacer { height: 12px; }
  .error { color:#B91C1C; font-weight:600; }
  .ok { color:#065F46; font-weight:600; }
  .btn-primary { display:inline-block; padding:12px 16px; border-radius:12px; background:#0EA5E9; color:#fff; text-decoration:none; }
  .btn-primary:disabled { opacity:.6; }
  img.logo { height: 18px; vertical-align:middle; }
  code { background:#f3f4f6; padding:2px 6px; border-radius:6px; }
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Pago con PayPhone</h1>
      <p class="muted">Revisa el detalle y continúa para completar tu pago de forma segura.</p>
      <div id="detalle" class="row"></div>
      <div class="spacer"></div>
      <div class="center">
        <div id="botones">
          <button id="crearBtn" class="btn-primary">Generar enlace de pago</button>
        </div>
        <div class="spacer"></div>
        <div id="estado" class="muted"></div>
        <div id="errorText" class="error"></div>
      </div>
    </div>
  </div>

<script>
(function(){
  const qs = new URLSearchParams(location.search);
  const productos = qs.get("productos") || "";
  const monto = parseFloat(qs.get("monto") || "0") || 0;
  const deviceId = qs.get("deviceId") || "";

  // Muestra breve detalle
  const detalle = document.getElementById("detalle");
  if (productos) detalle.appendChild(chip("Productos", decodeURIComponent(productos)));
  detalle.appendChild(chip("Monto", `$${monto.toFixed(2)}`));
  if (deviceId) detalle.appendChild(chip("Device", deviceId));

  function chip(label, value){
    const span = document.createElement("span");
    span.className = "pill";
    span.textContent = `${label}: ${value}`;
    return span;
  }

  async function crearBotonPago() {
    setEstado("Generando enlace seguro…");
    setError("");

    try {
      const res = await fetch("/api/create-payment.js".replace(/\.js$/,""), {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ productos, monto, deviceId })
      });

      const j = await res.json();
      if (!res.ok) throw j;

      const { url, clientTransactionId } = j;
      if (!url) throw { error: "No se recibió URL de pago." };

      const cont = document.getElementById("botones");
      cont.innerHTML = "";

      const a = document.createElement("a");
      a.className = "payment-button";
      a.href = url;
      a.target = "_blank";
      a.rel = "noopener";
      a.innerHTML = `Pagar ahora con <img class="logo" src="https://pay.payphonetodoesposible.com/Content/imgv3/payphone-h.svg" alt="PayPhone">`;
      cont.appendChild(a);

      setEstado(`Enlace generado. ID transacción: ${clientTransactionId}`);
    } catch (e) {
      console.error(e);
      setError(e?.error || "Error al preparar el pago");
      setEstado("");
    }
  }

  function setEstado(t){ document.getElementById("estado").textContent = t || ""; }
  function setError(t){ document.getElementById("errorText").textContent = t || ""; }

  document.getElementById("crearBtn").addEventListener("click", crearBotonPago);

  // Opcional: auto-generar enlace al cargar
  // crearBotonPago();
})();
</script>
</body>
</html>
