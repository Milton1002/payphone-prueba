<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gracias por tu compra - MACVASQUEZ</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f8f9fa;
      color: #333;
      line-height: 1.6;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 800px;
      margin: 40px auto;
      padding: 30px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    }
    h1 {
      color: #27ae60;
      text-align: center;
      margin-bottom: 30px;
    }
    .status-box {
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
      text-align: center;
    }
    .approved {
      background-color: #e8f5e9;
      border-left: 5px solid #27ae60;
    }
    .rejected {
      background-color: #ffebee;
      border-left: 5px solid #e74c3c;
    }
    .product-table {
      width: 100%;
      border-collapse: collapse;
      margin: 25px 0;
    }
    .product-table th {
      background-color: #2c3e50;
      color: white;
      padding: 12px;
      text-align: left;
    }
    .product-table td {
      padding: 12px;
      border-bottom: 1px solid #ddd;
    }
    .product-table tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    .total-row {
      font-weight: bold;
      background-color: #ecf0f1 !important;
    }
    .info-card {
      background-color: #f0f7ff;
      padding: 20px;
      border-radius: 8px;
      margin: 25px 0;
      border-left: 5px solid #6e8efb;
    }
    .btn {
      display: inline-block;
      background-color: #2c3e50;
      color: white;
      padding: 12px 25px;
      text-decoration: none;
      border-radius: 6px;
      font-weight: bold;
      transition: all 0.3s;
      margin-top: 20px;
    }
    .btn:hover {
      background-color: #1a252f;
      transform: translateY(-2px);
    }
    .footer {
      text-align: center;
      margin-top: 40px;
      color: #7f8c8d;
      font-size: 14px;
    }
    .hidden {
      display: none;
    }
    .loading {
      text-align: center;
      padding: 20px;
    }
    .spinner {
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>‚úÖ ¬°Gracias por tu compra en MACVASQUEZ!</h1>
    
    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p>Verificando tu pago...</p>
    </div>
    
    <div id="respuesta" class="hidden">
      <div id="status-box" class="status-box">
        <!-- Contenido din√°mico -->
      </div>
      
      <h2>Detalle de tu compra</h2>
      <table id="product-table" class="product-table">
        <thead>
          <tr>
            <th>Producto</th>
            <th>Cantidad</th>
            <th>Precio Unitario</th>
            <th>Subtotal</th>
          </tr>
        </thead>
        <tbody id="product-list">
          <!-- Productos se insertar√°n aqu√≠ -->
        </tbody>
        <tfoot>
          <tr class="total-row">
            <td colspan="3">Total</td>
            <td id="total-amount">$0.00</td>
          </tr>
        </tfoot>
      </table>
      
      <div id="info-card" class="info-card">
        <h3>üì¶ Informaci√≥n de acceso</h3>
        <p id="access-info">Tus credenciales de acceso estar√°n disponibles en tu correo electr√≥nico.</p>
        <div id="credentials" class="hidden">
          <p><strong>Usuario:</strong> <span id="user-email"></span></p>
          <p><strong>Contrase√±a:</strong> MAC2024!</p>
          <p><a href="https://macvasquez.com/mi-cuenta" target="_blank">Acceder a mi cuenta</a></p>
        </div>
      </div>
      
      <div id="payment-details" class="hidden">
        <h3>üìÑ Detalles del pago</h3>
        <p><strong>Referencia:</strong> <span id="reference"></span></p>
        <p><strong>Tarjeta:</strong> <span id="card-brand"></span> (***<span id="last-four"></span>)</p>
        <p><strong>Fecha:</strong> <span id="transaction-date"></span></p>
      </div>
      
      <center>
        <a href="https://www.macvasquez.com" class="btn">Volver al sitio</a>
      </center>
    </div>
  </div>
  
  <div class="footer">
    <p>Este es un mensaje autom√°tico. Para consultas, contacta a: info@macvasquez.com</p>
  </div>

  <!-- Iframe oculto para evitar redirecci√≥n -->
  <iframe name="hiddenFrame" style="display:none;"></iframe>

  <script>
    // Obtener par√°metros de la URL
    function getQueryParam(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    // Parsear productos desde URL
    function parseProducts(productosStr) {
      if (!productosStr) return [];
      return productosStr.split(',').map(item => {
        const [nombre, cantidad, precio] = item.split('|');
        return {
          nombre: decodeURIComponent(nombre),
          cantidad: parseInt(cantidad),
          precio: parseFloat(precio)
        };
      });
    }

    // Mostrar productos en la tabla
    function displayProducts(products) {
      const productList = document.getElementById('product-list');
      let total = 0;
      
      products.forEach(prod => {
        const subtotal = prod.precio * prod.cantidad;
        total += subtotal;
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${prod.nombre}</td>
          <td>${prod.cantidad}</td>
          <td>$${prod.precio.toFixed(2)}</td>
          <td>$${subtotal.toFixed(2)}</td>
        `;
        productList.appendChild(row);
      });
      
      document.getElementById('total-amount').textContent = `$${total.toFixed(2)}`;
      return total;
    }

    // Enviar datos al Google Script
    async function sendDataToGoogleScript(formData) {
      const scriptUrl = 'https://script.google.com/macros/s/AKfycbxfDsqFyc1qtztsXukZqnT5LE97GpPe94JD7tmzfuam1jB4YjflzYobjNkdDnjHPJnwZw/exec';
      
      try {
        // Intento con POST primero
        const response = await fetch(scriptUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({payload: formData})
        });
        
        if (!response.ok) throw new Error('Error en POST');
        
        return await response.json();
      } catch (postError) {
        console.log("Fallando a GET...", postError);
        // Fallback a GET si POST falla
        const getUrl = `${scriptUrl}?payload=${encodeURIComponent(JSON.stringify(formData))}`;
        
        // Usamos una imagen oculta como √∫ltimo recurso
        const img = document.createElement('img');
        img.src = getUrl;
        img.style.display = 'none';
        document.body.appendChild(img);
        
        return {status: 'success', method: 'GET'};
      }
    }

    // Funci√≥n principal
    async function init() {
      const id = getQueryParam('id');
      const clientTxId = getQueryParam('clientTransactionId');
      const productosParam = getQueryParam('productos');
      const productos = parseProducts(productosParam);
      const email = getQueryParam('email');
      
      // Mostrar productos mientras se verifica el pago
      if (productos.length > 0) {
        displayProducts(productos);
      }

      try {
        // Preparar datos para enviar al script
        const formData = {
          id: id,
          clientTransactionId: clientTxId,
          productos: productosParam,
          email: email,
          transactionDate: new Date().toISOString()
        };

        // Mostrar datos de acceso si hay email
        if (email) {
          document.getElementById('credentials').classList.remove('hidden');
          document.getElementById('user-email').textContent = email;
        }

        // Enviar datos al Google Script
        const scriptResponse = await sendDataToGoogleScript(formData);
        console.log("Respuesta del script:", scriptResponse);

        document.getElementById('loading').classList.add('hidden');
        document.getElementById('respuesta').classList.remove('hidden');
        
        const statusBox = document.getElementById('status-box');
        
        statusBox.classList.add('approved');
        statusBox.innerHTML = `
          <h2 style="color:#27ae60;">‚úîÔ∏è Pago Aprobado</h2>
          <p>Hemos confirmado tu pago exitosamente. Revisa tu correo para m√°s detalles.</p>
        `;
        
        // Mostrar detalles del pago
        document.getElementById('payment-details').classList.remove('hidden');
        document.getElementById('reference').textContent = id || "N/A";
        document.getElementById('transaction-date').textContent = new Date().toLocaleString();

      } catch (error) {
        console.error("Error:", error);
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('respuesta').classList.remove('hidden');
        
        const statusBox = document.getElementById('status-box');
        statusBox.classList.add('rejected');
        statusBox.innerHTML = `
          <h2 style="color:#e74c3c;">‚ö†Ô∏è Error en el proceso</h2>
          <p>Hemos registrado tu pago pero hubo un problema al enviar los detalles. Por favor cont√°ctanos con tu n√∫mero de referencia.</p>
          <p><strong>Referencia:</strong> ${id || "N/A"}</p>
        `;
      }
    }

    // Iniciar cuando el DOM est√© listo
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
